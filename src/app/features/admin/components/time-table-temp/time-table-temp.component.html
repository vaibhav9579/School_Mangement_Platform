<div class="p-4 sm:p-8 max-w-7xl mx-auto font-sans bg-gray-50 min-h-screen">
      <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Timetable Builder</h1>
      <!-- <p class="text-lg text-gray-500 mb-6">Visually assign subjects to time slots for **{{ selectedFilters().class }} - {{ selectedFilters().section }}**.</p> -->

      <!-- --- Filters & Actions --- -->
      <div class="flex flex-col md:flex-row gap-4 mb-8 p-4 bg-white rounded-xl shadow-lg border border-gray-100">
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Select Class</label>
          <select
            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
            [value]="selectedFilters().class"
            (change)="updateFilter('class', $event)"
          >
            @for (c of ['Class-1', 'Class-2', 'Class-3', 'Class-4', 'Class-5']; track c) {
              <option [value]="c">{{ c }}</option>
            }
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Select Section</label>
          <select
            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
            [value]="selectedFilters().section"
            (change)="updateFilter('section', $event)"
          >
            @for (s of ['A', 'B', 'C', 'D']; track s) {
              <option [value]="s">{{ s }}</option>
            }
          </select>
        </div>
        <div class="md:w-auto flex items-end">
          <button class="w-full md:w-auto px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150">
            Save Timetable
          </button>
        </div>
      </div>

      <div class="flex flex-col lg:flex-row gap-8">
        <!-- --- Timetable Grid (Main Area) --- -->
        <div class="flex-1 overflow-x-auto bg-white p-4 rounded-xl shadow-xl">
          <table class="min-w-full border-collapse">
            <thead>
              <tr>
                <th class="sticky left-0 bg-white z-20 w-32 p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b-2 border-gray-200">Time</th>
                @for (day of DAYS; track day) {
                  <th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider border-b-2 border-gray-200">
                    {{ day }}
                  </th>
                }
              </tr>
            </thead>
            <tbody>
              @for (slot of TIME_SLOTS; track slot) {
                <tr class="hover:bg-gray-50">
                  <td class="sticky left-0 bg-white z-20 p-3 text-sm font-semibold text-gray-800 border-r border-gray-200">
                    @if (slot.includes('Break')) {
                      <span class="text-red-500">{{ slot }}</span>
                    } @else {
                      {{ slot }}
                    }
                  </td>
                  @for (day of DAYS; track day) {
                    <td class="p-1">
                      @if (timetableData()[day]) {
                        <!-- Cell Rendering Logic -->
                        <div
                          class="p-2 border border-gray-100 h-20 text-xs font-medium transition-all duration-150 rounded-lg"
                          [class.bg-gray-100]="slot.includes('Break')"
                          [class.text-gray-500]="slot.includes('Break')"
                          [class.italic]="slot.includes('Break')"
                          [class.text-center]="slot.includes('Break')"
                          [class.text-sm]="slot.includes('Break')"
                          [class.font-semibold]="slot.includes('Break')"
                          [class.cursor-default]="slot.includes('Break')"
                          [class.cursor-pointer]="!slot.includes('Break')"
                          
                          [class]="timetableData()[day][slot]?.color || 'bg-white'"
                          [class.text-white]="timetableData()[day][slot]"
                          [class.shadow-lg]="timetableData()[day][slot]"
                          [class.transform]="timetableData()[day][slot]"
                          [class.hover:scale-[1.01]]="timetableData()[day][slot]"
                          [class.hover:shadow-xl]="timetableData()[day][slot]"

                          [class.bg-white]="!timetableData()[day][slot] && !slot.includes('Break')"
                          [class.text-gray-400]="!timetableData()[day][slot] && !slot.includes('Break')"
                          [class.hover:bg-indigo-50]="!timetableData()[day][slot] && !slot.includes('Break')"
                          [class.hover:text-indigo-600]="!timetableData()[day][slot] && !slot.includes('Break')"
                          [class.border-dashed]="!timetableData()[day][slot] && !slot.includes('Break')"
                          
                          [class.ring-4]="editingCell()?.day === day && editingCell()?.slot === slot"
                          [class.ring-offset-2]="editingCell()?.day === day && editingCell()?.slot === slot"
                          [class.ring-indigo-400]="editingCell()?.day === day && editingCell()?.slot === slot"
                          [class.z-10]="editingCell()?.day === day && editingCell()?.slot === slot"
                          
                          (click)="handleCellClick(day, slot)"
                        >
                          @if (slot.includes('Break')) {
                            {{ timetableData()[day][slot]?.name || 'Break' }}
                          } @else if (timetableData()[day][slot]) {
                            <div class="flex flex-col h-full justify-between">
                              <span class="text-sm font-bold truncate">{{ timetableData()[day][slot]!.name }}</span>
                              <span class="text-xs font-light opacity-80 truncate">{{ timetableData()[day][slot]!.teacher }}</span>
                            </div>
                          } @else {
                            <span class='flex items-center justify-center h-full'>+ Assign Subject</span>
                          }
                        </div>
                      }
                    </td>
                  }
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- --- Subject Palette / Editing Panel --- -->
        <div class="lg:w-80 w-full p-4 bg-white rounded-xl shadow-xl sticky top-4 self-start h-fit">
          <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
            @if (editingCell()) {
              Editing: {{ editingCell()!.day }} - {{ editingCell()!.slot }}
            } @else {
              Subject Palette
            }
          </h2>

          @if (editingCell()) {
            <div class="space-y-3">
              <p class="text-sm text-gray-500">Select a subject to assign to this slot.</p>
              
              <!-- Assignment Options: FIX APPLIED HERE -->
              @for (subject of SUBJECT_TEACHERS; track subject.id) {
                <button
                  (click)="handleAssignment(subject)"
                  class="w-full p-3 text-left rounded-lg text-white font-semibold shadow-md transition duration-150 transform hover:-translate-y-0.5"
                  [class]="subject.color + ' ' + subject.hover"
                >
                  <span class="block text-sm">{{ subject.name }}</span>
                  <span class="block text-xs opacity-80">{{ subject.teacher }}</span>
                </button>
              }

              <div class="pt-2 border-t mt-3">
                <button
                  (click)="handleAssignment('REMOVE')"
                  class="w-full p-3 text-sm bg-red-100 text-red-600 font-semibold rounded-lg hover:bg-red-200 transition duration-150 mt-2"
                >
                  Clear/Remove Assignment
                </button>
                <button
                  (click)="editingCell.set(null)"
                  class="w-full p-3 text-sm bg-gray-100 text-gray-600 font-semibold rounded-lg hover:bg-gray-200 transition duration-150 mt-2"
                >
                  Cancel
                </button>
              </div>
            </div>
          } @else {
            <!-- Palette View when not editing -->
            <div class="space-y-3">
              <p class="text-sm text-gray-500">Click a slot in the grid to start editing.</p>
              <div class="mt-4 grid grid-cols-2 gap-3">
                @for (subject of SUBJECT_TEACHERS; track subject.id) {
                  <div [class]="subject.color" class="p-2 rounded-lg text-white font-semibold shadow-md">
                    <span class="block text-sm truncate">{{ subject.name }}</span>
                    <span class="block text-xs opacity-80 truncate">{{ subject.teacher.split(' ').pop() }}</span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    </div>
